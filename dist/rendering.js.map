{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","events","on","legendType","render","setTimeout","getLegendHeight","panelHeight","legend","show","percentage","values","breakPoint","parseInt","total","length","Math","min","floor","formatter","label","slice","slice_data","decimal","start","fontSize","color","percentageDecimals","formatValue","percent","toFixed","noDataPoints","html","addPieChart","width","height","size","plotCanvas","plotCss","margin","position","paddingBottom","css","backgroundColor","options","series","pie","stroke","parseFloat","strokeWidth","highlight","opacity","combine","threshold","grid","hoverable","clickable","pieType","innerRadius","countData","i","hiddenSeries","sort","valueName","sortDesc","a","b","legendData","totalValues","append","plot","bind","event","pos","item","detach","body","formatted","_","escape","place_tt","pageX","pageY","incrementRenderCounter","renderingCompleted"],"mappings":";;;;;;;AAKe,WAASA,IAAT,CAAcC,KAAd,EAAqBC,IAArB,EAA2BC,KAA3B,EAAkCC,IAAlC,EAAwC;AACrD,QAAIC,IAAJ;AACA,QAAIC,KAAK,GAAGF,IAAI,CAACE,KAAjB;AACAJ,IAAAA,IAAI,GAAGA,IAAI,CAACK,IAAL,CAAU,wBAAV,CAAP;AACA,QAAIC,QAAQ,GAAGC,CAAC,CAAC,oBAAD,CAAhB;AAEAL,IAAAA,IAAI,CAACM,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAyB,YAAY;AACnC,UAAIL,KAAK,CAACM,UAAN,KAAqB,YAAzB,EAAuC;AACrCC,QAAAA,MAAM,CAAC,KAAD,CAAN;AACAC,QAAAA,UAAU,CAAC,YAAY;AAAED,UAAAA,MAAM,CAAC,IAAD,CAAN;AAAe,SAA9B,EAAgC,EAAhC,CAAV;AACD,OAHD,MAGO;AACLA,QAAAA,MAAM,CAAC,IAAD,CAAN;AACD;AACF,KAPD;;AASA,aAASE,eAAT,CAAyBC,WAAzB,EAAsC;AACpC,UAAI,CAACZ,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBC,IAAnB,IAA2Bd,IAAI,CAACE,KAAL,CAAWM,UAAX,KAA0B,YAArD,IAAqER,IAAI,CAACE,KAAL,CAAWM,UAAX,KAA0B,UAAnG,EAA+G;AAC7G,eAAO,EAAP;AACD;;AAED,UAAIR,IAAI,CAACE,KAAL,CAAWM,UAAX,IAAyB,aAAzB,IAA0CR,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBE,UAA5D,IAA0Ef,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBG,MAAhG,EAAwG;AACtG,YAAIC,UAAU,GAAGC,QAAQ,CAAClB,IAAI,CAACE,KAAL,CAAWe,UAAZ,CAAR,GAAkC,GAAnD;AACA,YAAIE,KAAK,GAAG,KAAK,KAAKlB,IAAI,CAACmB,MAA3B;AACA,eAAOC,IAAI,CAACC,GAAL,CAASH,KAAT,EAAgBE,IAAI,CAACE,KAAL,CAAWX,WAAW,GAAGK,UAAzB,CAAhB,CAAP;AACD;AACF;;AAED,aAASO,SAAT,CAAmBC,KAAnB,EAA0BC,KAA1B,EAAiC;AAC/B,UAAIC,UAAU,GAAGD,KAAK,CAACzB,IAAN,CAAW,CAAX,EAAcyB,KAAK,CAACzB,IAAN,CAAW,CAAX,EAAcmB,MAAd,GAAuB,CAArC,CAAjB;AACA,UAAIQ,OAAO,GAAG,CAAd;AACA,UAAIC,KAAK,GAAG,2BAA2B7B,IAAI,CAACE,KAAL,CAAW4B,QAAtC,GAAiD,uCAAjD,GAA2FJ,KAAK,CAACK,KAAjG,GAAyG,KAAzG,GAAiHN,KAAjH,GAAyH,OAArI;;AAEA,UAAIzB,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBmB,kBAAtB,EAA0C;AACxCJ,QAAAA,OAAO,GAAG5B,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBmB,kBAA5B;AACD;;AACD,UAAIhC,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBG,MAAlB,IAA4BhB,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBE,UAAlD,EAA8D;AAC5D,eAAOc,KAAK,GAAG7B,IAAI,CAACiC,WAAL,CAAiBN,UAAjB,CAAR,GAAuC,OAAvC,GAAiDD,KAAK,CAACQ,OAAN,CAAcC,OAAd,CAAsBP,OAAtB,CAAjD,GAAkF,SAAzF;AACD,OAFD,MAEO,IAAI5B,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBG,MAAtB,EAA8B;AACnC,eAAOa,KAAK,GAAG7B,IAAI,CAACiC,WAAL,CAAiBN,UAAjB,CAAR,GAAuC,QAA9C;AACD,OAFM,MAEA,IAAI3B,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBE,UAAtB,EAAkC;AACvC,eAAOc,KAAK,GAAGH,KAAK,CAACQ,OAAN,CAAcC,OAAd,CAAsBP,OAAtB,CAAR,GAAyC,SAAhD;AACD,OAFM,MAEA;AACL,eAAOC,KAAK,GAAG,QAAf;AACD;AACF;;AAED,aAASO,YAAT,GAAwB;AACtB,UAAIC,IAAI,GAAG,iFAAX;AACAvC,MAAAA,IAAI,CAACuC,IAAL,CAAUA,IAAV;AACD;;AAED,aAASC,WAAT,GAAuB;AACrB,UAAIC,KAAK,GAAGzC,IAAI,CAACyC,KAAL,EAAZ;AACA,UAAIC,MAAM,GAAGxC,IAAI,CAACwC,MAAL,GAAc7B,eAAe,CAACX,IAAI,CAACwC,MAAN,CAA1C;AAEA,UAAIC,IAAI,GAAGpB,IAAI,CAACC,GAAL,CAASiB,KAAT,EAAgBC,MAAhB,CAAX;AAEA,UAAIE,UAAU,GAAGrC,CAAC,CAAC,aAAD,CAAlB;AACA,UAAIsC,OAAO,GAAG;AACZC,QAAAA,MAAM,EAAE,MADI;AAEZC,QAAAA,QAAQ,EAAE,UAFE;AAGZC,QAAAA,aAAa,EAAE,KAAK,IAHR;AAIZN,QAAAA,MAAM,EAAEC,IAAI,GAAG;AAJH,OAAd;AAOAC,MAAAA,UAAU,CAACK,GAAX,CAAeJ,OAAf;AAEA,UAAIK,eAAe,GAAG3C,CAAC,CAAC,MAAD,CAAD,CAAU0C,GAAV,CAAc,kBAAd,CAAtB;AAEA,UAAIE,OAAO,GAAG;AACZpC,QAAAA,MAAM,EAAE;AACNC,UAAAA,IAAI,EAAE;AADA,SADI;AAIZoC,QAAAA,MAAM,EAAE;AACNC,UAAAA,GAAG,EAAE;AACHrC,YAAAA,IAAI,EAAE,IADH;AAEHsC,YAAAA,MAAM,EAAE;AACNrB,cAAAA,KAAK,EAAEiB,eADD;AAENT,cAAAA,KAAK,EAAEc,UAAU,CAACrD,IAAI,CAACE,KAAL,CAAWoD,WAAZ,CAAV,CAAmCnB,OAAnC,CAA2C,CAA3C;AAFD,aAFL;AAMHV,YAAAA,KAAK,EAAE;AACLX,cAAAA,IAAI,EAAEd,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkBC,IAAlB,IAA0Bd,IAAI,CAACE,KAAL,CAAWM,UAAX,KAA0B,UADrD;AAELgB,cAAAA,SAAS,EAAEA;AAFN,aANJ;AAUH+B,YAAAA,SAAS,EAAE;AACTC,cAAAA,OAAO,EAAE;AADA,aAVR;AAaHC,YAAAA,OAAO,EAAE;AACPC,cAAAA,SAAS,EAAE1D,IAAI,CAACE,KAAL,CAAWuD,OAAX,CAAmBC,SADvB;AAEPjC,cAAAA,KAAK,EAAEzB,IAAI,CAACE,KAAL,CAAWuD,OAAX,CAAmBhC;AAFnB;AAbN;AADC,SAJI;AAwBZkC,QAAAA,IAAI,EAAE;AACJC,UAAAA,SAAS,EAAE,IADP;AAEJC,UAAAA,SAAS,EAAE;AAFP;AAxBM,OAAd;;AA8BA,UAAI3D,KAAK,CAAC4D,OAAN,KAAkB,OAAtB,EAA+B;AAC7Bb,QAAAA,OAAO,CAACC,MAAR,CAAeC,GAAf,CAAmBY,WAAnB,GAAiC,GAAjC;AACD;;AAED9D,MAAAA,IAAI,GAAGD,IAAI,CAACC,IAAZ;AACA,UAAI+D,SAAS,GAAG,CAAhB;;AAEA,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGhE,IAAI,CAACmB,MAAzB,EAAiC6C,CAAC,EAAlC,EAAsC;AACpC;AACAD,QAAAA,SAAS,IAAI/D,IAAI,CAACgE,CAAD,CAAJ,CAAQhE,IAArB;AACA,YAAIiD,MAAM,GAAGjD,IAAI,CAACgE,CAAD,CAAjB,CAHoC,CAKpC;;AACA,YAAIjE,IAAI,CAACkE,YAAL,CAAkBhB,MAAM,CAACzB,KAAzB,CAAJ,EAAqC;AACnCyB,UAAAA,MAAM,CAACjD,IAAP,GAAc,EAAd;AACD;AACF,OAhEoB,CAkErB;;;AAEA,UAAIC,KAAK,CAACW,MAAN,CAAasD,IAAjB,EAAuB;AACrB,YAAInE,IAAI,CAACE,KAAL,CAAWkE,SAAX,KAAyBlE,KAAK,CAACW,MAAN,CAAasD,IAA1C,EAAgD;AAC9CjE,UAAAA,KAAK,CAACW,MAAN,CAAasD,IAAb,GAAoBnE,IAAI,CAACE,KAAL,CAAWkE,SAA/B;AACD;;AACD,YAAIlE,KAAK,CAACW,MAAN,CAAawD,QAAb,KAA0B,IAA9B,EAAoC;AAClCpE,UAAAA,IAAI,CAACkE,IAAL,CAAU,UAAUG,CAAV,EAAaC,CAAb,EAAgB;AACxB,mBAAOA,CAAC,CAACC,UAAF,GAAeF,CAAC,CAACE,UAAxB;AACD,WAFD;AAGD,SAJD,MAIO;AACLvE,UAAAA,IAAI,CAACkE,IAAL,CAAU,UAAUG,CAAV,EAAaC,CAAb,EAAgB;AACxB,mBAAOD,CAAC,CAACE,UAAF,GAAeD,CAAC,CAACC,UAAxB;AACD,WAFD;AAGD;AACF;;AAED1E,MAAAA,IAAI,CAACuC,IAAL,CAAUK,UAAV;;AAEA,UAAI1C,IAAI,CAACE,KAAL,CAAWW,MAAX,CAAkB4D,WAAtB,EAAmC;AACjC3E,QAAAA,IAAI,CAAC4E,MAAL,6CAA+C1E,IAAI,CAACiC,WAAL,CAAiB+B,SAAjB,CAA/C;AACD;;AAED3D,MAAAA,CAAC,CAACsE,IAAF,CAAOjC,UAAP,EAAmBzC,IAAnB,EAAyBgD,OAAzB;AACAP,MAAAA,UAAU,CAACkC,IAAX,CAAgB,WAAhB,EAA6B,UAAUC,KAAV,EAAiBC,GAAjB,EAAsBC,IAAtB,EAA4B;AACvD,YAAI,CAACA,IAAL,EAAW;AACT3E,UAAAA,QAAQ,CAAC4E,MAAT;AACA;AACD;;AAED,YAAIC,IAAJ;AACA,YAAI/C,OAAO,GAAGmB,UAAU,CAAC0B,IAAI,CAAC7B,MAAL,CAAYhB,OAAb,CAAV,CAAgCC,OAAhC,CAAwC,CAAxC,CAAd;AACA,YAAI+C,SAAS,GAAGlF,IAAI,CAACiC,WAAL,CAAiB8C,IAAI,CAAC7B,MAAL,CAAYjD,IAAZ,CAAiB,CAAjB,EAAoB,CAApB,CAAjB,CAAhB;AAEAgF,QAAAA,IAAI,GAAG,yEAAP;AACAA,QAAAA,IAAI,IAAI,yCAAyCE,CAAC,CAACC,MAAF,CAASL,IAAI,CAAC7B,MAAL,CAAYzB,KAArB,CAAzC,GAAuE,IAAvE,GAA8EyD,SAAtF;AACAD,QAAAA,IAAI,IAAI,OAAO/C,OAAP,GAAiB,IAAjB,GAAwB,QAAhC;AACA+C,QAAAA,IAAI,IAAI,cAAR;AAEA7E,QAAAA,QAAQ,CAACiC,IAAT,CAAc4C,IAAd,EAAoBI,QAApB,CAA6BP,GAAG,CAACQ,KAAJ,GAAY,EAAzC,EAA6CR,GAAG,CAACS,KAAjD;AACD,OAhBD;AAiBD;;AAED,aAAS9E,MAAT,CAAgB+E,sBAAhB,EAAwC;AACtC,UAAI,CAACxF,IAAI,CAACC,IAAV,EAAgB;AAAE;AAAS;;AAE3BA,MAAAA,IAAI,GAAGD,IAAI,CAACC,IAAZ;;AAEE,UAAI,KAAKD,IAAI,CAACC,IAAL,CAAUmB,MAAnB,EAA2B;AACzBgB,QAAAA,YAAY;AACb,OAFD,MAEO;AACLE,QAAAA,WAAW;AACZ;;AAEH,UAAIkD,sBAAJ,EAA4B;AAC1BxF,QAAAA,IAAI,CAACyF,kBAAL;AACD;AACF;AACF;;qBA/KuB7F,I;;;;AALjBuF,MAAAA,C;;AACA9E,MAAAA,C","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data;\n  var panel = ctrl.panel;\n  elem = elem.find('.piechart-panel__chart');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  ctrl.events.on('render', function () {\n    if (panel.legendType === 'Right side') {\n      render(false);\n      setTimeout(function () { render(true); }, 50);\n    } else {\n      render(true);\n    }\n  });\n\n  function getLegendHeight(panelHeight) {\n    if (!ctrl.panel.legend.show || ctrl.panel.legendType === 'Right side' || ctrl.panel.legendType === 'On graph') {\n      return 20;\n    }\n\n    if (ctrl.panel.legendType == 'Under graph' && ctrl.panel.legend.percentage || ctrl.panel.legend.values) {\n      let breakPoint = parseInt(ctrl.panel.breakPoint) / 100;\n      var total = 23 + 20 * data.length;\n      return Math.min(total, Math.floor(panelHeight * breakPoint));\n    }\n  }\n\n  function formatter(label, slice) {\n    var slice_data = slice.data[0][slice.data[0].length - 1];\n    var decimal = 2;\n    var start = \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\";\n\n    if (ctrl.panel.legend.percentageDecimals) {\n      decimal = ctrl.panel.legend.percentageDecimals;\n    }\n    if (ctrl.panel.legend.values && ctrl.panel.legend.percentage) {\n      return start + ctrl.formatValue(slice_data) + \"<br/>\" + slice.percent.toFixed(decimal) + \"%</div>\";\n    } else if (ctrl.panel.legend.values) {\n      return start + ctrl.formatValue(slice_data) + \"</div>\";\n    } else if (ctrl.panel.legend.percentage) {\n      return start + slice.percent.toFixed(decimal) + \"%</div>\";\n    } else {\n      return start + '</div>';\n    }\n  }\n\n  function noDataPoints() {\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\n    elem.html(html);\n  }\n\n  function addPieChart() {\n    var width = elem.width();\n    var height = ctrl.height - getLegendHeight(ctrl.height);\n\n    var size = Math.min(width, height);\n\n    var plotCanvas = $('<div></div>');\n    var plotCss = {\n      margin: 'auto',\n      position: 'relative',\n      paddingBottom: 20 + 'px',\n      height: size + 'px'\n    };\n\n    plotCanvas.css(plotCss);\n\n    var backgroundColor = $('body').css('background-color')\n\n    var options = {\n      legend: {\n        show: false\n      },\n      series: {\n        pie: {\n          show: true,\n          stroke: {\n            color: backgroundColor,\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\n          },\n          label: {\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\n            formatter: formatter\n          },\n          highlight: {\n            opacity: 0.0\n          },\n          combine: {\n            threshold: ctrl.panel.combine.threshold,\n            label: ctrl.panel.combine.label\n          }\n        }\n      },\n      grid: {\n        hoverable: true,\n        clickable: false\n      }\n    };\n\n    if (panel.pieType === 'donut') {\n      options.series.pie.innerRadius = 0.5;\n    }\n\n    data = ctrl.data;\n    var countData = 0;\n\n    for (let i = 0; i < data.length; i++) {\n      // console.log(\"DATA:\", data[i]);\n      countData += data[i].data;\n      let series = data[i];\n\n      // if hidden remove points\n      if (ctrl.hiddenSeries[series.label]) {\n        series.data = {};\n      }\n    }\n\n    // console.log(countData);\n\n    if (panel.legend.sort) {\n      if (ctrl.panel.valueName !== panel.legend.sort) {\n        panel.legend.sort = ctrl.panel.valueName;\n      }\n      if (panel.legend.sortDesc === true) {\n        data.sort(function (a, b) {\n          return b.legendData - a.legendData;\n        });\n      } else {\n        data.sort(function (a, b) {\n          return a.legendData - b.legendData;\n        });\n      }\n    }\n\n    elem.html(plotCanvas);\n\n    if (ctrl.panel.legend.totalValues) {\n      elem.append(`<div style=\"text-align:center;\">${ctrl.formatValue(countData)}</div>`);\n    }\n\n    $.plot(plotCanvas, data, options);\n    plotCanvas.bind(\"plothover\", function (event, pos, item) {\n      if (!item) {\n        $tooltip.detach();\n        return;\n      }\n\n      var body;\n      var percent = parseFloat(item.series.percent).toFixed(2);\n      var formatted = ctrl.formatValue(item.series.data[0][1]);\n\n      body = '<div class=\"piechart-tooltip-small\"><div class=\"piechart-tooltip-time\">';\n      body += '<div class=\"piechart-tooltip-value\">' + _.escape(item.series.label) + ': ' + formatted;\n      body += \" (\" + percent + \"%)\" + '</div>';\n      body += \"</div></div>\";\n\n      $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\n    });\n  }\n\n  function render(incrementRenderCounter) {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n\n      if (0 == ctrl.data.length) {\n        noDataPoints();\n      } else {\n        addPieChart();\n      }\n\n    if (incrementRenderCounter) {\n      ctrl.renderingCompleted();\n    }\n  }\n}\n\n"],"file":"rendering.js"}